<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Venteliste-dashboard</title>
  <style>
    :root { --bg:#0b0c10; --card:#12141b; --text:#e8e9ee; --muted:#9aa0ab; --border:rgba(255,255,255,0.10); }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 22px; }
    header { display:flex; justify-content: space-between; align-items: flex-end; gap: 16px; flex-wrap: wrap; margin-bottom: 14px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: 0.2px; }
    .sub { margin: 0; color: var(--muted); font-size: 13px; }
    .stamp { color: var(--muted); font-size: 12px; }
    .grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .cardHead { display:flex; justify-content: space-between; gap: 10px; align-items: start; }
    .title { font-size: 16px; margin: 0; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 3px; }
    .kpis { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); font-size: 12px; color: var(--text); }

    /* House "goal" pinned top-right of the card (outside the SVG) */
    .goalWrap { display:flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .goal { display:flex; align-items:center; gap: 8px; padding: 8px 10px; border-radius: 12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); }
    .goalIcon { width: 22px; height: 22px; display:inline-block; }
    .goalText { font-size: 12px; color: rgba(255,255,255,0.85); line-height: 1.1; text-align:right; }
    .goalSub { font-size: 11px; color: var(--muted); margin-top: 2px; }

    svg { width: 100%; height: 200px; display:block; margin-top: 8px; }
    .error { background: rgba(255, 0, 0, 0.08); border:1px solid rgba(255,0,0,0.25); color: rgba(255,255,255,0.9); padding: 10px 12px; border-radius: 12px; margin-top: 12px; display:none; }
    code { color: rgba(255,255,255,0.85); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Venteliste-dashboard</h1>
        <p class="sub">Gr√• = skrevet op efter baseline ¬∑ Lysere sort = passeret siden start ¬∑ R√∏d = din datter ¬∑ üè† er m√•l (altid helt til h√∏jre i kortets header).</p>
      </div>
      <div class="stamp" id="updatedAt">Indl√¶ser‚Ä¶</div>
    </header>

    <div id="error" class="error"></div>
    <div id="grid" class="grid"></div>
  </div>

  <svg width="0" height="0" style="position:absolute; left:-9999px; top:-9999px;" aria-hidden="true">
    <defs>
      <linearGradient id="trackGrad" x1="0" x2="1">
        <stop offset="0" stop-color="rgba(255,255,255,0.12)"></stop>
        <stop offset="1" stop-color="rgba(255,255,255,0.04)"></stop>
      </linearGradient>

      <g id="silhouette">
        <circle cx="10" cy="8" r="7" fill="rgba(0,0,0,0.85)"></circle>
        <rect x="3" y="16" width="14" height="34" rx="7" fill="rgba(0,0,0,0.85)"></rect>
        <rect x="0" y="26" width="20" height="8" rx="4" fill="rgba(0,0,0,0.85)"></rect>
      </g>

      <g id="girl">
        <circle cx="12" cy="8" r="7" fill="#1a1a1a"></circle>
        <path d="M12 16 L2 50 Q12 58 22 50 Z" fill="#c1121f"></path>
        <rect x="6" y="16" width="12" height="10" rx="5" fill="#1a1a1a"></rect>
      </g>
    </defs>
  </svg>

  <script>
    const VISUAL_SLOTS  = 50;

    // SVG only shows the queue (no house inside SVG anymore)
    const VIEW_W        = 980;
    const VIEW_H        = 200;

    const TRACK_START_X = 90;
    const TRACK_END_X   = 860;
    const TRACK_Y       = 132;

    const SIL_Y         = 84;
    const GIRL_Y        = 84;

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    // 0..1 (0=bagerst, 1=forrest). pos=1 => ~1
    function computeProgress(pos, total){
      total = Math.max(2, total);
      pos = clamp(pos, 1, total);
      return clamp((total - pos) / (total - 1), 0, 1);
    }

    function visualIndex(progress){ return Math.round(progress * VISUAL_SLOTS); }
    function xForSlot(slot){
      const t = slot / VISUAL_SLOTS;
      return TRACK_START_X + t * (TRACK_END_X - TRACK_START_X);
    }

    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k === "class") e.className = v;
        else e.setAttribute(k, v);
      }
      for(const c of children) e.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      return e;
    }

    function svgEl(tag){
      return document.createElementNS("http://www.w3.org/2000/svg", tag);
    }

    function makeHouseIcon(){
      // Tiny inline SVG (as DOM) so it always sits top-right in the header
      const s = document.createElementNS("http://www.w3.org/2000/svg","svg");
      s.setAttribute("viewBox","0 0 24 24");
      s.setAttribute("class","goalIcon");
      const roof = document.createElementNS("http://www.w3.org/2000/svg","path");
      roof.setAttribute("d","M12 3 L3 10.2 V21 H9.2 V14.8 H14.8 V21 H21 V10.2 Z");
      roof.setAttribute("fill","rgba(255,255,255,0.28)");
      const door = document.createElementNS("http://www.w3.org/2000/svg","rect");
      door.setAttribute("x","10.2"); door.setAttribute("y","15"); door.setAttribute("width","3.6"); door.setAttribute("height","6");
      door.setAttribute("fill","rgba(255,255,255,0.42)");
      s.appendChild(roof); s.appendChild(door);
      return s;
    }

    function buildQueueSvg(queue){
      const svg = svgEl("svg");
      svg.setAttribute("viewBox", `0 0 ${VIEW_W} ${VIEW_H}`);

      // Track
      const track = svgEl("rect");
      track.setAttribute("x", String(TRACK_START_X - 20));
      track.setAttribute("y", String(TRACK_Y));
      track.setAttribute("width", String((TRACK_END_X - (TRACK_START_X - 20))));
      track.setAttribute("height","10");
      track.setAttribute("rx","5");
      track.setAttribute("fill","url(#trackGrad)");
      svg.appendChild(track);

      // People silhouettes (color rules based on start_position)
      const peopleG = svgEl("g");

      const total = Math.max(2, Number(queue.total || 2));
      const curPos = clamp(Number(queue.position || total), 1, total);
      const startPos = Number.isFinite(queue.start_position) ? Number(queue.start_position) : null;

      for (let i = 0; i < VISUAL_SLOTS; i++) {
        const x = xForSlot(i);

        // i=0 is back (pos ~ total), i=VISUAL_SLOTS is front (pos ~ 1)
        const posRep = total - Math.round((i / VISUAL_SLOTS) * (total - 1));

        // New joiners after baseline: behind the baseline start position
        const isNewAfterStart = (startPos !== null) && (posRep > startPos);

        // People she has passed since baseline: between current and start
        const passedSinceStart =
          (startPos !== null) && (posRep <= startPos) && (posRep > curPos);

        const u = svgEl("use");
        u.setAttribute("href", "#silhouette");
        u.setAttribute("transform", `translate(${x}, ${SIL_Y})`);

        const opacity =
          isNewAfterStart ? 0.22 :
          passedSinceStart ? 0.72 :
          0.92;

        u.setAttribute("opacity", String(opacity));
        peopleG.appendChild(u);
      }
      svg.appendChild(peopleG);

      // Girl marker
      const girlMarker = svgEl("g");
      girlMarker.style.transition = "transform 900ms cubic-bezier(.2,.8,.2,1)";
      const gUse = svgEl("use");
      gUse.setAttribute("href","#girl");
      girlMarker.appendChild(gUse);
      svg.appendChild(girlMarker);

      // Label
      const label = svgEl("text");
      label.setAttribute("x", String(TRACK_START_X - 20));
      label.setAttribute("y","30");
      label.setAttribute("fill","rgba(255,255,255,0.7)");
      label.setAttribute("font-size","13");
      svg.appendChild(label);

      function render(pos, total, onKpis){
        total = Math.max(2, total);
        pos = clamp(pos, 1, total);

        const progress = computeProgress(pos, total);
        const slot = visualIndex(progress);
        const x = xForSlot(slot);

        girlMarker.setAttribute("transform", `translate(${x}, ${GIRL_Y})`);
        label.textContent = `Nr. ${pos} af ${total} ‚Äî mod lejligheden`;

        if(typeof onKpis === "function"){
          onKpis({pos, total, progress, slot});
        }
      }

      return { svg, render };
    }

    function showError(msg){
      const e = document.getElementById("error");
      e.style.display = "block";
      e.innerHTML = msg;
    }

    async function loadData(){
      const res = await fetch("./data/current.json", { cache: "no-store" });
      if(!res.ok){
        throw new Error(`Kunne ikke hente data/current.json (HTTP ${res.status}).`);
      }
      return await res.json();
    }

    function buildCard(queue, updatedAt){
      const title = el("h2", { class:"title" }, [queue.name]);
      const meta = el("div", { class:"meta" }, [`Sidst opdateret: ${updatedAt}`]);

      // Goal UI in top-right (always right side)
      const goalBox = el("div", { class:"goalWrap" }, [
        el("div", { class:"goal" }, [
          makeHouseIcon(),
          el("div", {}, [
            el("div", { class:"goalText" }, ["M√•l: Lejligheden"]),
            el("div", { class:"goalSub" }, ["(altid i h√∏jre side)"])
          ])
        ])
      ]);

      const head = el("div", { class:"cardHead" }, [
        el("div", {}, [title, meta]),
        goalBox
      ]);

      const kpi1 = el("div", { class:"pill" }, ["Placering: ‚Äì"]);
      const kpi2 = el("div", { class:"pill" }, ["Fremgang: ‚Äì"]);
      const kpi3 = el("div", { class:"pill" }, ["Baseline: ‚Äì"]);
      const kpi4 = el("div", { class:"pill" }, ["Uge/M√•ned/√Ör: ‚Äì"]);
      const kpis = el("div", { class:"kpis" }, [kpi1, kpi2, kpi3]);
      kpis.appendChild(kpi4);

      const card = el("div", { class:"card" }, [head, kpis]);

      const { svg, render } = buildQueueSvg(queue);
      card.appendChild(svg);

      render(queue.position, queue.total, ({pos, total}) => {
        kpi1.textContent = `Placering: ${pos} / ${total}`;

        const moved = Number.isFinite(queue.moved) ? queue.moved : null;
        const movedPct = Number.isFinite(queue.moved_pct) ? queue.moved_pct : null;
        if(moved === null || movedPct === null){
          kpi2.textContent = `Fremgang: ‚Äì`;
        } else {
          const sign = moved > 0 ? "+" : "";
          const dir = moved > 0 ? "frem" : (moved < 0 ? "tilbage" : "u√¶ndret");
          kpi2.textContent = `Fremgang: ${sign}${moved} ${dir} (${movedPct.toFixed(2)}%)`;
        }

        const sp = Number.isFinite(queue.start_position) ? queue.start_position : null;
        kpi3.textContent = sp === null ? "Baseline: ‚Äì" : `Baseline: ${sp}`;

        const prog = queue.progress || {};
        const wk = Number.isFinite(prog.week) ? prog.week : null;
        const mo = Number.isFinite(prog.month) ? prog.month : null;
        const yr = Number.isFinite(prog.year) ? prog.year : null;
        const parts = [];
        if(wk !== null) parts.push(`uge ${wk > 0 ? "+" : ""}${wk}`);
        if(mo !== null) parts.push(`md ${mo > 0 ? "+" : ""}${mo}`);
        if(yr !== null) parts.push(`√•r ${yr > 0 ? "+" : ""}${yr}`);
        kpi4.textContent = parts.length ? `Uge/M√•ned/√Ör: ${parts.join(" ¬∑ ")}` : "Uge/M√•ned/√Ör: (bygger data)";
      });

      return card;
    }

    async function main(){
      try{
        const data = await loadData();
        const updatedAt = data.updated_at ?? "ukendt";
        document.getElementById("updatedAt").textContent = `Data: ${updatedAt}`;

        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        const queues = Array.isArray(data.queues) ? data.queues : [];
        if(!queues.length){
          showError(`Ingen k√∏er fundet i <code>data/current.json</code>.`);
          return;
        }

        for(const q of queues){
          if(!q || !q.id || !q.name || !Number.isFinite(q.position) || !Number.isFinite(q.total)){
            showError(`Ugyldigt queue-entry i <code>data/current.json</code>. Tjek at hvert entry har <code>id,name,position,total</code>.`);
            return;
          }
          grid.appendChild(buildCard(q, updatedAt));
        }
      } catch(err){
        showError(`Fejl: ${String(err.message || err)}<br><br>
          Tjek at du har committed <code>data/current.json</code> og at GitHub Pages er sl√•et til.`);
        console.error(err);
      }
    }

    main();
  </script>
</body>
</html>
